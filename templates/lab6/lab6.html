{% extends "base.html" %}

{% block lab %}Лабораторная работа 6{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='lab6.css') }}">
{% endblock %}

{% block main %}
<div class="lab6-container">
    <a href="{{ url_for('lab5.main') }}" class="btn btn-return">← Вернуться к лабораторной 5</a>
    
    <h1>Аренда офисов</h1>
    
    <!-- Информация о пользователе -->
    <div class="user-info-box">
        <p>Текущий пользователь: 
            <strong id="current-user">
                {% if session.get('login') %}
                    {{ session.get('login') }}
                {% else %}
                    Не авторизован
                {% endif %}
            </strong>
        </p>
        {% if not session.get('login') %}
        <p style="color: #e74c3c; margin-top: 10px;">
            ⚠️ Для бронирования офиса необходимо авторизоваться
        </p>
        {% endif %}
    </div>
    
    <!-- Контейнер списка офисов -->
    <div class="office-list-container">
        <h2> Список офисов</h2>
        
        <!-- Сообщение о загрузке -->
        <div id="loading-message" class="loading">
            Загрузка списка офисов...
        </div>
        
        <!-- Список офисов (будет заполнен JavaScript) -->
        <ul id="office-list"></ul>
        
        <!-- Сообщение если нет офисов -->
        <div id="no-offices-message" style="display: none; text-align: center; color: #6c757d;">
            Нет доступных офисов
        </div>
    </div>
    
    <!-- Блок общей стоимости -->
    <div class="total-price-container">
        <p id="total-price">Загрузка информации...</p>
    </div>
    
    <!-- Информация о системе -->
    <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; font-size: 14px;">
        <h3 style="color: #2c3e50; margin-top: 0;">ℹ Как пользоваться системой:</h3>
        <ul style="color: #555;">
            <li>Для бронирования офиса нажмите кнопку <strong>"Забронировать"</strong></li>
            <li>Для отмены бронирования нажмите кнопку <strong>"Освободить"</strong></li>
            <li>Один пользователь может арендовать несколько офисов</li>
            <li>Стоимость аренды указана за месяц</li>
            <li>Общая стоимость рассчитывается автоматически</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
// Функция для получения списка офисов
function getOfficeList() {
    // Скрываем сообщение об отсутствии офисов
    document.getElementById('no-offices-message').style.display = 'none';
    
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "info",
        "id": Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        // Скрываем сообщение о загрузке
        document.getElementById('loading-message').style.display = 'none';
        
        if (data.error) {
            console.error('Ошибка от сервера:', data.error);
            showError('Ошибка при загрузке офисов: ' + data.error.message);
            return;
        }
        
        // Получаем список офисов
        const officeList = data.result;
        const ul = document.getElementById('office-list');
        ul.innerHTML = ''; // Очищаем список
        
        if (officeList.length === 0) {
            document.getElementById('no-offices-message').style.display = 'block';
            return;
        }
        
        // Считаем общую стоимость арендованных офисов
        let totalPrice = 0;
        const currentUser = "{{ session.get('login', '') }}";
        
        // Для каждого офиса создаем элемент списка
        officeList.forEach(office => {
            const li = document.createElement('li');
            li.className = 'office-item';
            
            // Определяем статус офиса
            const isOccupied = office.tenant ? true : false;
            const isMyOffice = office.tenant === currentUser;
            
            // Формируем HTML для офиса
            li.innerHTML = `
                <div class="office-header">
                    <div class="office-title">Офис №${office.number}</div>
                    <div class="office-price">${office.price} руб./мес.</div>
                </div>
                <div class="office-details">
                    <div class="office-status ${isOccupied ? 'status-occupied' : 'status-free'}">
                        ${isOccupied ? `Занят (${office.tenant})` : 'Свободен'}
                    </div>
                    <div class="office-actions" id="actions-${office.number}"></div>
                </div>
            `;
            
            // Добавляем кнопки действий
            const actionsDiv = li.querySelector(`#actions-${office.number}`);
            
            // Кнопка бронирования (только если офис свободен)
            if (!isOccupied) {
                const bookBtn = document.createElement('button');
                bookBtn.className = 'btn btn-book';
                bookBtn.innerHTML = ' Забронировать';
                bookBtn.onclick = function() {
                    booking(office.number);
                };
                actionsDiv.appendChild(bookBtn);
            }
            
            // Кнопка отмены (только если офис арендован текущим пользователем)
            if (isMyOffice) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-cancel';
                cancelBtn.innerHTML = ' Освободить';
                cancelBtn.onclick = function() {
                    cancellation(office.number);
                };
                actionsDiv.appendChild(cancelBtn);
                
                // Добавляем стоимость к общей сумме
                totalPrice += office.price;
            }
            
            ul.appendChild(li);
        });
        
        // Обновляем общую стоимость
        updateTotalPrice(totalPrice);
    })
    .catch(error => {
        console.error('Ошибка при выполнении запроса:', error);
        showError('Ошибка соединения с сервером');
        document.getElementById('loading-message').style.display = 'none';
    });
}

// Функция для обновления общей стоимости
function updateTotalPrice(totalPrice) {
    const totalElem = document.getElementById('total-price');
    if (totalPrice > 0) {
        totalElem.innerHTML = `
            Общая стоимость вашей аренды: 
            <span class="total-price-amount">${totalPrice} руб./мес.</span>
        `;
    } else {
        totalElem.textContent = 'У вас нет арендованных офисов';
    }
}

// Функция для бронирования офиса
function booking(officeNumber) {
    showMessage(`Пытаемся забронировать офис №${officeNumber}...`, 'info');
    
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "booking",
        "params": officeNumber,
        "id": Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            switch(data.error.code) {
                case 1:
                    showError('Вы не авторизованы. Пожалуйста, войдите в систему.');
                    break;
                case 2:
                    showError('Офис уже занят другим пользователем.');
                    break;
                default:
                    showError('Ошибка: ' + data.error.message);
            }
        } else {
            showMessage('✅ Офис успешно забронирован!', 'success');
            getOfficeList(); // Обновляем список
        }
    })
    .catch(error => {
        console.error('Ошибка при бронировании:', error);
        showError('Ошибка соединения с сервером');
    });
}

// Функция для отмены бронирования
function cancellation(officeNumber) {
    if (!confirm(`Вы уверены, что хотите освободить офис №${officeNumber}?`)) {
        return;
    }
    
    showMessage(`Отменяем бронь офиса №${officeNumber}...`, 'info');
    
    const url = '/lab6/json-rpc-api/';
    const json = {
        "jsonrpc": "2.0",
        "method": "cancellation",
        "params": officeNumber,
        "id": Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            switch(data.error.code) {
                case 1:
                    showError('Вы не авторизованы.');
                    break;
                case 3:
                    showError('Вы не можете отменить чужую аренду.');
                    break;
                default:
                    showError('Ошибка: ' + data.error.message);
            }
        } else {
            showMessage('✅ Бронь успешно отменена!', 'success');
            getOfficeList(); // Обновляем список
        }
    })
    .catch(error => {
        console.error('Ошибка при отмене:', error);
        showError('Ошибка соединения');
    });
}

// Вспомогательные функции для уведомлений
function showMessage(text, type = 'info') {
    // Удаляем старые сообщения
    const oldMessages = document.querySelectorAll('.temp-message');
    oldMessages.forEach(msg => msg.remove());
    
    // Создаем новое сообщение
    const messageDiv = document.createElement('div');
    messageDiv.className = `temp-message ${type === 'error' ? 'error-message' : 'success-message'}`;
    messageDiv.textContent = text;
    messageDiv.style.margin = '10px 0';
    messageDiv.style.padding = '10px';
    messageDiv.style.borderRadius = '4px';
    messageDiv.style.animation = 'fadeIn 0.3s';
    
    // Добавляем в начало контейнера
    const container = document.querySelector('.lab6-container');
    container.insertBefore(messageDiv, container.firstChild);
    
    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 500);
        }
    }, 5000);
}

function showError(text) {
    showMessage(text, 'error');
}

// Добавляем CSS анимацию
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
document.head.appendChild(style);

// Загружаем список офисов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('Страница lab6 загружена');
    setTimeout(() => {
        getOfficeList();
    }, 500); // Небольшая задержка для плавности
});
</script>
{% endblock %}